name: Publish to PyPI

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v0.9.6, v1.0.0

permissions:
  contents: write      # For creating GitHub releases
  id-token: write      # For PyPI trusted publishing (OIDC)

jobs:
  validate-and-build:
    name: Validate Tag and Build Packages
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.extract_version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: extract_version
        run: |
          TAG=${GITHUB_REF#refs/tags/v}
          echo "version=$TAG" >> $GITHUB_OUTPUT
          echo "Building version: $TAG"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install build tools
        run: |
          npm install -g yarn
          python -m pip install --upgrade pip build

      - name: Update version in jupyterlab-amphi
        working-directory: jupyterlab-amphi
        run: |
          VERSION=${{ steps.extract_version.outputs.version }}
          npm version $VERSION --no-git-tag-version
          echo "__version__ = \"$VERSION\"" > _version.py

      - name: Update version in amphi-scheduler
        working-directory: amphi-scheduler
        run: |
          VERSION=${{ steps.extract_version.outputs.version }}
          npm version $VERSION --no-git-tag-version
          echo "__version__ = \"$VERSION\"" > _version.py
          echo "__version__ = '$VERSION'" > packages/pipeline-scheduler/pipeline_scheduler/version.py

      - name: Update version in amphi-etl
        working-directory: amphi-etl
        run: |
          VERSION=${{ steps.extract_version.outputs.version }}
          npm version $VERSION --no-git-tag-version
          echo "# This file is auto-generated by Hatchling. As such, do not:" > amphi/_version.py
          echo "#   - modify" >> amphi/_version.py
          echo "#   - track in version control e.g. be sure to add to .gitignore" >> amphi/_version.py
          echo "__version__ = '$VERSION'" >> amphi/_version.py
          # Update requirements.txt to reference correct version
          sed -i "s|# jupyterlab-amphi==.*|jupyterlab-amphi==$VERSION|" requirements.txt
          sed -i "s|# amphi-scheduler==.*|amphi-scheduler==$VERSION|" requirements.txt
          # Update setup.py with new versions
          sed -i "s/version='[^']*'/version='$VERSION'/" setup.py
          sed -i "s/jupyterlab-amphi==[0-9.]*/jupyterlab-amphi==$VERSION/" setup.py
          sed -i "s/amphi-scheduler==[0-9.]*/amphi-scheduler==$VERSION/" setup.py

      - name: Build jupyterlab-amphi
        working-directory: jupyterlab-amphi
        run: |
          jlpm install
          jlpm lint:check || echo "Linting warnings - continuing"
          jlpm build:prod
          python -m build

      - name: Build amphi-scheduler
        working-directory: amphi-scheduler
        run: |
          jlpm install
          jlpm lint:check || echo "Linting warnings - continuing"
          jlpm build:prod
          python -m build

      - name: Build amphi-etl
        working-directory: amphi-etl
        run: |
          jlpm install
          jlpm lint:check || echo "Linting warnings - continuing"
          jlpm build:prod
          python -m build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-packages
          path: |
            jupyterlab-amphi/dist/*
            amphi-scheduler/dist/*
            amphi-etl/dist/*
          retention-days: 7

  publish-jupyterlab-amphi:
    name: Publish jupyterlab-amphi to PyPI
    needs: validate-and-build
    runs-on: ubuntu-latest
    environment:
      name: pypi-jupyterlab-amphi
      url: https://pypi.org/p/jupyterlab-amphi

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-packages

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: jupyterlab-amphi/dist/

  publish-amphi-scheduler:
    name: Publish amphi-scheduler to PyPI
    needs: [validate-and-build, publish-jupyterlab-amphi]
    runs-on: ubuntu-latest
    environment:
      name: pypi-amphi-scheduler
      url: https://pypi.org/p/amphi-scheduler

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-packages

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: amphi-scheduler/dist/

  publish-amphi-etl:
    name: Publish amphi-etl to PyPI
    needs: [validate-and-build, publish-amphi-scheduler]
    runs-on: ubuntu-latest
    environment:
      name: pypi-amphi-etl
      url: https://pypi.org/p/amphi-etl

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-packages

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: amphi-etl/dist/

  create-github-release:
    name: Create GitHub Release
    needs: [validate-and-build, publish-amphi-etl]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-packages
          path: dist-all/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release v${{ needs.validate-and-build.outputs.version }}
          body: |
            ## Amphi ETL v${{ needs.validate-and-build.outputs.version }}

            ### Packages Published
            - [jupyterlab-amphi ${{ needs.validate-and-build.outputs.version }}](https://pypi.org/project/jupyterlab-amphi/${{ needs.validate-and-build.outputs.version }}/)
            - [amphi-scheduler ${{ needs.validate-and-build.outputs.version }}](https://pypi.org/project/amphi-scheduler/${{ needs.validate-and-build.outputs.version }}/)
            - [amphi-etl ${{ needs.validate-and-build.outputs.version }}](https://pypi.org/project/amphi-etl/${{ needs.validate-and-build.outputs.version }}/)

            ### Installation
            ```bash
            pip install amphi-etl==${{ needs.validate-and-build.outputs.version }}
            ```

            ### Download Artifacts
            Wheel and source distribution files are attached to this release for manual installation.
          files: |
            dist-all/**/*.whl
            dist-all/**/*.tar.gz
          draft: false
          prerelease: false
